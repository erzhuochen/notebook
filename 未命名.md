# 心迹（Xiniji）心理健康服务系统 - 设计方案

  

## 五、设计方案

  

### 1. 系统业务流程图

  

#### 1.1 用户注册登录流程

  

```mermaid

graph TD

A[用户访问系统] --> B[输入手机号]

B --> C[点击获取验证码]

C --> D{验证码是否在有效期内?}

D -->|是,剩余时间>4分钟| E[提示发送过于频繁]

D -->|否| F[生成6位随机验证码]

F --> G[调用阿里云短信服务]

G --> H[发送短信到用户手机]

H --> I[验证码存入Redis,过期时间5分钟]

I --> J[用户收到验证码]

J --> K[输入手机号和验证码]

K --> L[点击登录]

L --> M{验证码是否正确?}

M -->|否| N[返回错误提示]

M -->|是| O{用户是否存在?}

O -->|否| P[创建新用户记录]

O -->|是| Q[获取用户信息]

P --> Q

Q --> R[生成JWT Token]

R --> S[返回Token和用户信息]

S --> T[前端存储Token]

T --> U[跳转到首页]

```

  

#### 1.2 情绪日记记录与AI分析流程

  

```mermaid

graph TD

A[用户进入日记写作页面] --> B[选择日记日期]

B --> C[选择情绪标签<br/>可多选:喜悦/悲伤/愤怒等]

C --> D[选择情境分类<br/>可多选:工作/家庭/社交等]

D --> E[输入日记内容]

E --> F[点击保存]

F --> G{当天是否已有日记?}

G -->|是| H[提示已存在,需先删除]

G -->|否| I[保存日记到MySQL数据库]

I --> J[日记ID和内容加入异步队列]

J --> K[返回保存成功响应]

K --> L[前端显示保存成功]

J --> M[后台异步任务开始]

M --> N{AI模型类型?}

N -->|Mock模式| O[生成模拟分析结果]

N -->|真实模式| P[调用AI模型API]

P --> Q[传入日记文本]

Q --> R[AI模型进行情绪识别]

R --> S[提取关键词]

S --> T[识别认知偏差]

T --> U[生成个性化建议]

U --> V[评估心理风险等级]

O --> W[AI分析结果存入MongoDB]

V --> W

W --> X[更新日记analyzed状态为true]

X --> Y[更新日记analysisId字段]

Y --> Z[分析完成]

L --> AA[用户刷新页面]

AA --> AB[查看AI分析结果]

```

  

#### 1.3 周报生成流程

  

```mermaid

graph TD

A[用户访问周报页面] --> B{本周周报是否已生成?}

B -->|是| C[从MongoDB获取周报数据]

B -->|否| D[触发周报生成]

D --> E[获取本周一的日期]

E --> F[查询本周所有日记记录]

F --> G{是否有日记?}

G -->|否| H[返回空结果]

G -->|是| I[获取所有日记的AI分析结果]

I --> J[统计情绪分布<br/>JOY:2次, CALM:3次等]

J --> K[计算主导情绪<br/>出现次数最多的情绪]

K --> L[构建情绪趋势数据<br/>按日期和强度排列]

L --> M[计算平均情绪强度]

M --> N[生成周报洞察文本<br/>本周记录X篇日记,主要情绪为XX]

N --> O[分析亮点<br/>积极情绪占比高等]

O --> P[分析关注点<br/>高风险天数等]

P --> Q[周报数据保存到MongoDB]

Q --> C

C --> R[前端渲染周报]

R --> S[显示总览卡片<br/>日记数/主导情绪/平均强度]

S --> T[绘制ECharts折线图<br/>情绪趋势曲线]

T --> U[显示情绪分布进度条]

U --> V{用户是否为Pro会员?}

V -->|是| W[显示深度洞察标签页]

V -->|否| X[显示Pro功能引导]

```

  

#### 1.4 会员订阅与支付流程

  

```mermaid

graph TD

A[用户访问会员中心] --> B[查看会员计划<br/>月度¥29/季度¥78/年度¥288]

B --> C[选择会员计划]

C --> D[点击立即开通]

D --> E[创建订单记录]

E --> F[生成唯一订单号<br/>使用雪花算法]

F --> G[订单状态:PENDING<br/>过期时间:30分钟后]

G --> H[返回订单信息]

H --> I[前端打开支付对话框]

I --> J[显示支付二维码<br/>支持微信/支付宝]

J --> K[用户扫码支付]

K --> L[第三方支付平台处理]

L --> M[支付成功]

M --> N[支付平台回调后端接口<br/>POST /member/payment/callback]

N --> O[验证订单是否存在]

O --> P{订单状态是否为PENDING?}

P -->|否| Q[返回订单状态异常]

P -->|是| R[更新订单状态为PAID]

R --> S[记录支付时间和流水号]

S --> T[查询用户信息]

T --> U{用户是否有有效会员?}

U -->|是| V[从当前会员到期时间开始计算]

U -->|否| W[从当前时间开始计算]

V --> X[计算新的到期时间<br/>月度+30天/季度+90天/年度+365天]

W --> X

X --> Y[更新用户会员等级为PRO]

Y --> Z[更新会员到期时间]

Z --> AA[保存用户信息]

AA --> AB[前端轮询订单状态]

AB --> AC[显示支付成功]

AC --> AD[跳转到会员中心]

AD --> AE[显示会员权益]

```

  

#### 1.5 定时任务流程

  

```mermaid

graph TD

A[系统启动] --> B[注册定时任务<br/>@Scheduled]

B --> C[等待触发时间]

C --> D[每周一凌晨1点]

D --> E[定时任务触发]

E --> F[获取所有活跃用户列表]

F --> G[遍历每个用户]

G --> H[计算上周日期范围<br/>周一到周日]

H --> I[生成上周周报]

I --> J{是否还有用户?}

J -->|是| G

J -->|否| K[定时任务完成]

K --> L[等待下次触发]

L --> C

```

  

---

  

### 2. 系统功能结构图

  

```

心迹心理健康服务系统

│

├── 用户认证模块

│ ├── 手机号验证码登录

│ │ ├── 发送短信验证码

│ │ ├── 验证码校验

│ │ └── JWT Token生成

│ ├── 用户注册（自动）

│ └── 退出登录

│

├── 用户管理模块

│ ├── 个人信息管理

│ │ ├── 查看个人信息

│ │ ├── 修改昵称

│ │ └── 上传头像

│ ├── 数据管理

│ │ ├── 导出用户数据

│ │ └── 注销账号

│ └── 会员状态查询

│

├── 情绪日记模块

│ ├── 日记管理

│ │ ├── 创建日记

│ │ ├── 编辑日记

│ │ ├── 删除日记

│ │ └── 查看日记详情

│ ├── 日记查询

│ │ ├── 分页列表查询

│ │ ├── 关键词搜索

│ │ ├── 日期范围查询

│ │ └── 获取今日日记

│ ├── 情绪标签选择

│ │ ├── 喜悦 (JOY)

│ │ ├── 悲伤 (SADNESS)

│ │ ├── 愤怒 (ANGER)

│ │ ├── 恐惧 (FEAR)

│ │ ├── 惊讶 (SURPRISE)

│ │ ├── 厌恶 (DISGUST)

│ │ ├── 焦虑 (ANXIETY)

│ │ └── 平静 (CALM)

│ ├── 情境分类选择

│ │ ├── 工作 (WORK)

│ │ ├── 家庭 (FAMILY)

│ │ ├── 社交 (SOCIAL)

│ │ ├── 健康 (HEALTH)

│ │ ├── 学习 (STUDY)

│ │ └── 其他 (OTHER)

│ └── 日记统计

│ ├── 总日记数

│ ├── 已分析日记数

│ ├── 本月日记数

│ └── 连续打卡天数

│

├── AI情绪分析模块

│ ├── 情绪识别

│ │ ├── 主导情绪识别

│ │ ├── 情绪强度评估

│ │ └── 多情绪混合分析

│ ├── 文本分析

│ │ ├── 关键词提取

│ │ ├── 情绪摘要生成

│ │ └── 认知偏差识别

│ ├── 个性化建议

│ │ ├── 心理调节建议

│ │ ├── 行为改善建议

│ │ └── 资源推荐

│ ├── 风险评估

│ │ ├── 低风险 (LOW)

│ │ ├── 中风险 (MEDIUM)

│ │ └── 高风险 (HIGH)

│ └── 异步分析处理

│ ├── Mock模式（开发环境）

│ └── AI模型调用（生产环境）

│

├── 周报生成模块

│ ├── 周报数据统计

│ │ ├── 本周日记数量

│ │ ├── 情绪分布统计

│ │ ├── 主导情绪计算

│ │ └── 平均强度计算

│ ├── 趋势分析

│ │ ├── 情绪趋势曲线

│ │ ├── 强度变化分析

│ │ └── 情绪波动识别

│ ├── 洞察生成

│ │ ├── 周报总结

│ │ ├── 亮点提取

│ │ └── 关注点标注

│ ├── 周报查询

│ │ ├── 当前周报

│ │ └── 历史周报列表

│ └── 定时任务

│ └── 每周一自动生成

│

├── 会员订阅模块

│ ├── 会员计划管理

│ │ ├── 月度会员（¥29/30天）

│ │ ├── 季度会员（¥78/90天）

│ │ └── 年度会员（¥288/365天）

│ ├── 订单管理

│ │ ├── 创建订单

│ │ ├── 查询订单状态

│ │ ├── 订单历史记录

│ │ └── 订单过期处理

│ ├── 支付集成

│ │ ├── 微信支付

│ │ ├── 支付宝

│ │ └── 支付回调处理

│ ├── 会员权益管理

│ │ ├── 深度洞察报告

│ │ ├── 个性化成长计划

│ │ ├── 情绪预警提醒

│ │ ├── 正念练习推荐

│ │ └── 长期趋势追踪

│ └── 自动续费设置

│ ├── 开启自动续费

│ └── 关闭自动续费

│

├── 危机干预模块

│ ├── 24小时心理热线

│ ├── 专业咨询服务

│ ├── 自助资源推荐

│ └── 紧急联系方式

│

└── 系统管理模块

├── 安全管理

│ ├── JWT认证

│ ├── 接口权限控制

│ ├── CORS配置

│ └── 数据加密

├── 异常处理

│ ├── 全局异常捕获

│ ├── 业务异常处理

│ └── 参数验证

├── 日志管理

│ ├── 操作日志记录

│ ├── 错误日志记录

│ └── 访问日志记录

└── 第三方服务集成

├── 阿里云短信服务

├── 阿里云OSS存储

└── AI模型服务

```

  

---

  

### 3. 类图（实体类图）

  

```mermaid

classDiagram

class User {

-Long id

-String phone

-String nickname

-String avatar

-MemberLevel memberLevel

-LocalDateTime memberExpireTime

-Boolean autoRenew

-Boolean deleted

-LocalDateTime createdAt

-LocalDateTime updatedAt

+getId() Long

+getPhone() String

+setNickname(String) void

+setMemberLevel(MemberLevel) void

}

class DiaryEntry {

-Long id

-Long userId

-LocalDate diaryDate

-String content

-List~EmotionType~ emotions

-List~ContextCategory~ contexts

-String analysisId

-Boolean analyzed

-Boolean deleted

-LocalDateTime createdAt

-LocalDateTime updatedAt

+getId() Long

+getUserId() Long

+getContent() String

+setAnalyzed(Boolean) void

}

class Order {

-Long id

-String orderNo

-Long userId

-PlanType planType

-BigDecimal amount

-OrderStatus status

-PaymentMethod paymentMethod

-String transactionId

-LocalDateTime paidAt

-LocalDateTime expiredAt

-LocalDateTime createdAt

+getOrderNo() String

+setStatus(OrderStatus) void

+setPaidAt(LocalDateTime) void

}

class AIAnalysisResult {

-String id

-Long userId

-Long diaryId

-String dominantEmotion

-Double intensity

-List~String~ keywords

-String summary

-List~String~ cognitiveBiases

-List~String~ suggestions

-String riskLevel

-Map rawModelOutput

-LocalDateTime createdAt

+getDominantEmotion() String

+getIntensity() Double

+getSuggestions() List

}

class WeeklyReport {

-String id

-Long userId

-LocalDate weekStart

-LocalDate weekEnd

-Integer totalDiaries

-String dominantEmotion

-Map~String,Integer~ emotionDistribution

-List~EmotionTrendPoint~ emotionTrend

-String weeklyInsight

-List~String~ highlights

-List~String~ concerns

-Double averageIntensity

-LocalDateTime createdAt

+getEmotionDistribution() Map

+getEmotionTrend() List

}

class EmotionTrendPoint {

-LocalDate date

-String emotion

-Double intensity

+getDate() LocalDate

+getEmotion() String

+getIntensity() Double

}

class MemberLevel {

<<enumeration>>

FREE

PRO

LIFETIME

}

class EmotionType {

<<enumeration>>

JOY

SADNESS

ANGER

FEAR

SURPRISE

DISGUST

ANXIETY

CALM

}

class ContextCategory {

<<enumeration>>

WORK

FAMILY

SOCIAL

HEALTH

STUDY

OTHER

}

class OrderStatus {

<<enumeration>>

PENDING

PAID

CANCELLED

REFUNDED

EXPIRED

}

class PlanType {

<<enumeration>>

MONTHLY

QUARTERLY

ANNUAL

}

class PaymentMethod {

<<enumeration>>

WECHAT

ALIPAY

}

User "1" --> "1" MemberLevel : has

User "1" --> "0..*" DiaryEntry : writes

User "1" --> "0..*" Order : places

User "1" --> "0..*" AIAnalysisResult : owns

User "1" --> "0..*" WeeklyReport : generates

DiaryEntry "1" --> "0..1" AIAnalysisResult : analyzed by

DiaryEntry "1" --> "1..*" EmotionType : contains

DiaryEntry "1" --> "1..*" ContextCategory : belongs to

Order "1" --> "1" PlanType : type

Order "1" --> "1" OrderStatus : status

Order "1" --> "0..1" PaymentMethod : paid by

WeeklyReport "1" --> "1..*" EmotionTrendPoint : contains

AIAnalysisResult "1" --> "1" DiaryEntry : analyzes

```

  

---

  

### 4. 数据库E-R图

  

```mermaid

erDiagram

USERS ||--o{ DIARY_ENTRIES : writes

USERS ||--o{ ORDERS : places

USERS ||--o{ AI_ANALYSIS_RESULTS : owns

USERS ||--o{ WEEKLY_REPORTS : generates

DIARY_ENTRIES ||--o{ DIARY_EMOTIONS : has

DIARY_ENTRIES ||--o{ DIARY_CONTEXTS : belongs_to

DIARY_ENTRIES ||--o| AI_ANALYSIS_RESULTS : analyzed_by

USERS {

BIGINT id PK "主键ID"

VARCHAR phone UK "手机号,唯一"

VARCHAR nickname "昵称"

VARCHAR avatar "头像URL"

VARCHAR member_level "会员等级:FREE/PRO/LIFETIME"

DATETIME member_expire_time "会员到期时间"

BOOLEAN auto_renew "是否自动续费"

BOOLEAN deleted "是否已删除"

DATETIME created_at "创建时间"

DATETIME updated_at "更新时间"

}

DIARY_ENTRIES {

BIGINT id PK "主键ID"

BIGINT user_id FK "用户ID"

DATE diary_date "日记日期"

TEXT content "日记内容"

VARCHAR analysis_id "MongoDB分析结果ID"

BOOLEAN analyzed "是否已分析"

BOOLEAN deleted "是否已删除"

DATETIME created_at "创建时间"

DATETIME updated_at "更新时间"

}

DIARY_EMOTIONS {

BIGINT diary_id FK "日记ID"

VARCHAR emotion "情绪类型:JOY/SADNESS等"

}

DIARY_CONTEXTS {

BIGINT diary_id FK "日记ID"

VARCHAR context "情境类型:WORK/FAMILY等"

}

ORDERS {

BIGINT id PK "主键ID"

VARCHAR order_no UK "订单号,唯一"

BIGINT user_id FK "用户ID"

VARCHAR plan_type "计划类型:MONTHLY/QUARTERLY/ANNUAL"

DECIMAL amount "金额"

VARCHAR status "订单状态:PENDING/PAID等"

VARCHAR payment_method "支付方式:WECHAT/ALIPAY"

VARCHAR transaction_id "第三方交易流水号"

DATETIME paid_at "支付时间"

DATETIME expired_at "订单过期时间"

DATETIME created_at "创建时间"

}

AI_ANALYSIS_RESULTS {

STRING _id PK "MongoDB主键"

LONG userId "用户ID"

LONG diaryId "日记ID"

STRING dominantEmotion "主导情绪"

DOUBLE intensity "情绪强度"

ARRAY keywords "关键词列表"

STRING summary "摘要"

ARRAY cognitiveBiases "认知偏差列表"

ARRAY suggestions "建议列表"

STRING riskLevel "风险等级:LOW/MEDIUM/HIGH"

OBJECT rawModelOutput "原始模型输出"

DATETIME createdAt "创建时间"

}

WEEKLY_REPORTS {

STRING _id PK "MongoDB主键"

LONG userId "用户ID"

DATE weekStart "周起始日期"

DATE weekEnd "周结束日期"

INTEGER totalDiaries "总日记数"

STRING dominantEmotion "主导情绪"

OBJECT emotionDistribution "情绪分布Map"

ARRAY emotionTrend "情绪趋势数组"

STRING weeklyInsight "周报洞察"

ARRAY highlights "亮点列表"

ARRAY concerns "关注点列表"

DOUBLE averageIntensity "平均强度"

DATETIME createdAt "创建时间"

}

```

  

#### 数据库设计说明：

  

**MySQL数据库（关系型数据）**

1. **users表**：存储用户基本信息、会员状态

- 索引：phone（唯一索引）、member_level

2. **diary_entries表**：存储日记核心数据

- 索引：user_id、diary_date、(user_id, diary_date)组合索引

- 外键：user_id → users.id

3. **diary_emotions表**：日记与情绪的多对多关系

- 索引：diary_id

- 外键：diary_id → diary_entries.id（级联删除）

4. **diary_contexts表**：日记与情境的多对多关系

- 索引：diary_id

- 外键：diary_id → diary_entries.id（级联删除）

5. **orders表**：存储订单信息

- 索引：order_no（唯一索引）、user_id、status

- 外键：user_id → users.id

  

**MongoDB数据库（文档型数据）**

1. **ai_analysis_results集合**：存储AI分析结果

- 索引：userId、diaryId

- 特点：结构灵活，支持嵌套数组和对象

2. **weekly_reports集合**：存储周报数据

- 复合索引：(userId, weekStart)

- 特点：支持复杂的嵌套结构（情绪趋势点数组）

  

**设计原则**

- 关系型数据使用MySQL，保证事务一致性

- 非结构化分析数据使用MongoDB，提高灵活性

- 通过analysisId字段关联MySQL和MongoDB数据

- 合理使用索引提高查询性能

- 软删除设计（deleted字段）保留数据历史

  

---

  

## 附录：技术架构图

  

```

┌─────────────────────────────────────────────────────────┐

│ 前端层 (Vue 3) │

│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │

│ │ 日记管理 │ │ AI分析 │ │ 周报展示 │ │ 会员中心 │ │

│ └──────────┘ └──────────┘ └──────────┘ └─────────┘ │

│ │ HTTP/HTTPS (Axios) │

└────────────────────┼───────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────┐

│ API网关层 (Spring Security) │

│ ┌────────────────────────────────────────────────────┐ │

│ │ JWT认证 │ CORS配置 │ 权限控制 │ 全局异常处理 │ │

│ └────────────────────────────────────────────────────┘ │

└────────────────────┬───────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────┐

│ 业务逻辑层 (Spring Boot 3) │

│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │

│ │AuthService│ │DiaryService│ │AIAnalysis│ │MemberSvc│ │

│ └──────────┘ └──────────┘ │ Service │ └─────────┘ │

│ ┌──────────┐ ┌──────────┐ └──────────┘ ┌─────────┐ │

│ │UserService│ │WeeklyRpt │ │SmsService│ │

│ └──────────┘ │ Service │ └─────────┘ │

│ └──────────┘ │

└────────────────────┬───────────────────────────────────┘

│

┌────────────┼────────────┐

│ │ │

▼ ▼ ▼

┌─────────────┐ ┌──────────┐ ┌──────────┐

│ MySQL │ │ MongoDB │ │ Redis │

│ (关系数据) │ │(分析数据) │ │ (缓存) │

│ │ │ │ │ │

│ • users │ │• analysis│ │• 验证码 │

│ • diaries │ │• reports │ │• session │

│ • orders │ │ │ │ │

└─────────────┘ └──────────┘ └──────────┘

│ │

└────────┬───┘

│

┌────────┴────────┐

▼ ▼

┌─────────────┐ ┌──────────────┐

│ 阿里云短信 │ │ AI模型服务 │

│ 服务 │ │(ChatGLM/BERT)│

└─────────────┘ └──────────────┘

```

  

此设计方案完整展示了心迹系统的业务流程、功能结构、类图和数据库设计，为系统的开发、测试和维护提供了完整的技术文档支撑。